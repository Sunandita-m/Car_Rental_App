import javax.swing.*;
import java.awt.*;
import java.io.*;
import java.time.LocalDate;
import java.time.temporal.ChronoUnit;
import java.util.*;
import java.util.stream.Collectors;

public class ProfessionalCarRentalApp extends JFrame {
    private static final long serialVersionUID = 1L;

    // Professional color scheme
    private final Color PRIMARY_COLOR = new Color(0, 82, 155);     // Deep blue
    private final Color SECONDARY_COLOR = new Color(0, 122, 204);  // Medium blue
    private final Color MANAGER_COLOR = new Color(46, 125, 50);    // Green for managers
    private final Color CUSTOMER_COLOR = new Color(30, 144, 255);  // Blue for customers
    private final Color BACKGROUND_COLOR = new Color(240, 244, 247);
    private final Color CARD_COLOR = Color.WHITE;
    private final Color TEXT_COLOR = new Color(51, 51, 51);

    // User types
    private static final String USER_CUSTOMER = "Customer";
    private static final String USER_MANAGER = "Fleet Manager";

    // Enhanced Car class
    static class SmartCar implements Serializable {
        private static final long serialVersionUID = 1L;
        String model, number, location;
        double ratePerDay;
        boolean available;
        int mileage, fuelLevel;
        LocalDate lastMaintenance;
        double rating;
        int rentalCount;
        String rentedTo;

        SmartCar(String model, String number, double ratePerDay, String location) {
            this.model = model;
            this.number = number;
            this.ratePerDay = ratePerDay;
            this.location = location;
            this.available = true;
            this.fuelLevel = 100;
            this.lastMaintenance = LocalDate.now();
            this.rating = 5.0;
            this.rentalCount = 0;
            this.rentedTo = null;
        }

        public double calculateDynamicPrice() {
            double basePrice = ratePerDay;
            if (LocalDate.now().getDayOfWeek().getValue() >= 6) {
                basePrice *= 1.3;
            }
            if (rentalCount > 10) {
                basePrice *= 1.2;
            }
            if (rating < 3.0) {
                basePrice *= 0.8;
            }
            return Math.round(basePrice * 100.0) / 100.0;
        }

        public String getMaintenanceStatus() {
            long daysSinceMaintenance = ChronoUnit.DAYS.between(lastMaintenance, LocalDate.now());
            if (daysSinceMaintenance > 180) {
                return "Needs Service";
            } else if (daysSinceMaintenance > 120) {
                return "Due Soon";
            }
            return "Good Condition";
        }

        @Override
        public String toString() {
            return String.format("%s (%s) - $%.2f/day - %s - Rating: %.1f/5", 
                model, number, calculateDynamicPrice(), 
                available ? "Available" : "Rented by " + rentedTo, rating);
        }
    }

    // Enhanced User class
    static class User implements Serializable {
        private static final long serialVersionUID = 1L;
        String username, password, userType;
        int loyaltyPoints;
        String badge;
        double totalSpent;

        User(String username, String password, String userType) {
            this.username = username;
            this.password = password;
            this.userType = userType;
            this.loyaltyPoints = userType.equals(USER_CUSTOMER) ? 100 : 0;
            this.badge = userType.equals(USER_CUSTOMER) ? "Bronze" : "Manager";
            this.totalSpent = 0;
        }

        public void addRentalPoints(double amount) {
            if (userType.equals(USER_CUSTOMER)) {
                int pointsEarned = (int)(amount / 10);
                loyaltyPoints += pointsEarned;
                totalSpent += amount;
                updateBadge();
            }
        }

        private void updateBadge() {
            if (totalSpent >= 10000) {
                badge = "Diamond";
            } else if (totalSpent >= 5000) {
                badge = "Gold";
            } else if (totalSpent >= 1000) {
                badge = "Silver";
            }
        }

        public double applyDiscount(double amount) {
            if (userType.equals(USER_CUSTOMER) && loyaltyPoints > 500) {
                return amount * 0.9;
            } else if (userType.equals(USER_CUSTOMER) && loyaltyPoints > 200) {
                return amount * 0.95;
            }
            return amount;
        }

        public boolean isCustomer() {
            return USER_CUSTOMER.equals(userType);
        }

        public boolean isManager() {
            return USER_MANAGER.equals(userType);
        }
    }

    // Rental record
    static class RentalRecord implements Serializable {
        private static final long serialVersionUID = 1L;
        String carNumber, username;
        LocalDate rentDate;
        double amount;
        int rating;

        RentalRecord(String carNumber, String username, LocalDate rentDate, double amount) {
            this.carNumber = carNumber;
            this.username = username;
            this.rentDate = rentDate;
            this.amount = amount;
            this.rating = 0;
        }
    }

    // Application data
    static ArrayList<SmartCar> cars = new ArrayList<>();
    static ArrayList<User> users = new ArrayList<>();
    static ArrayList<RentalRecord> rentals = new ArrayList<>();
    User loggedUser;

    // File names
    static final String CARS_FILE = "professional_cars.dat";
    static final String USERS_FILE = "professional_users.dat";
    static final String RENTALS_FILE = "professional_rentals.dat";

    // GUI
    CardLayout card;
    JPanel mainPanel;

    public ProfessionalCarRentalApp() {
        loadData();
        setupFrame();
        createPanels();
        setVisible(true);
    }

    private void setupFrame() {
        setTitle("Professional Car Rental System");
        setSize(800, 600);
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setLocationRelativeTo(null);
        setResizable(false);

        card = new CardLayout();
        mainPanel = new JPanel(card);
        mainPanel.setBackground(BACKGROUND_COLOR);
        add(mainPanel);
    }

    private void createPanels() {
        mainPanel.add(createUserTypePanel(), "UserType");
        mainPanel.add(createCustomerLoginPanel(), "CustomerLogin");
        mainPanel.add(createCustomerRegisterPanel(), "CustomerRegister");
        mainPanel.add(createManagerLoginPanel(), "ManagerLogin");
        mainPanel.add(createManagerRegisterPanel(), "ManagerRegister");
        mainPanel.add(createCustomerDashboardPanel(), "CustomerDashboard");
        mainPanel.add(createManagerDashboardPanel(), "ManagerDashboard");
        mainPanel.add(createAnalyticsPanel(), "Analytics");
    }

    private JPanel createUserTypePanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(BACKGROUND_COLOR);

        // Header
        JPanel headerPanel = new JPanel();
        headerPanel.setBackground(PRIMARY_COLOR);
        headerPanel.setPreferredSize(new Dimension(800, 80));
        JLabel title = new JLabel("Professional Car Rental System", SwingConstants.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 28));
        title.setForeground(Color.WHITE);
        headerPanel.add(title);
        panel.add(headerPanel, BorderLayout.NORTH);

        // Center content
        JPanel contentPanel = new JPanel(new GridBagLayout());
        contentPanel.setBackground(BACKGROUND_COLOR);
        contentPanel.setBorder(BorderFactory.createEmptyBorder(60, 100, 60, 100));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.insets = new Insets(20, 20, 20, 20);

        JLabel welcomeLabel = new JLabel("Welcome! Please select your role:", SwingConstants.CENTER);
        welcomeLabel.setFont(new Font("Segoe UI", Font.BOLD, 20));
        welcomeLabel.setForeground(TEXT_COLOR);
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 2;
        contentPanel.add(welcomeLabel, gbc);

        gbc.gridwidth = 1;
        gbc.gridy = 1; gbc.gridx = 0;
        JPanel customerPanel = createUserTypePanel("Customer", "Rent vehicles for your travel needs", CUSTOMER_COLOR);
        contentPanel.add(customerPanel, gbc);

        gbc.gridx = 1;
        JPanel managerPanel = createUserTypePanel("Fleet Manager", "Manage vehicle fleet and analytics", MANAGER_COLOR);
        contentPanel.add(managerPanel, gbc);

        panel.add(contentPanel, BorderLayout.CENTER);

        return panel;
    }

    private JPanel createUserTypePanel(String role, String description, Color color) {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(CARD_COLOR);
        panel.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(color, 2),
            BorderFactory.createEmptyBorder(20, 20, 20, 20)
        ));
        panel.setCursor(new Cursor(Cursor.HAND_CURSOR));
        panel.setPreferredSize(new Dimension(250, 120));

        JLabel roleLabel = new JLabel(role, SwingConstants.CENTER);
        roleLabel.setFont(new Font("Segoe UI", Font.BOLD, 18));
        roleLabel.setForeground(color);
        panel.add(roleLabel, BorderLayout.NORTH);

        JTextArea descArea = new JTextArea(description);
        descArea.setEditable(false);
        descArea.setLineWrap(true);
        descArea.setWrapStyleWord(true);
        descArea.setBackground(CARD_COLOR);
        descArea.setFont(new Font("Segoe UI", Font.PLAIN, 12));
        descArea.setForeground(TEXT_COLOR);
        descArea.setBorder(BorderFactory.createEmptyBorder(10, 0, 0, 0));
        panel.add(descArea, BorderLayout.CENTER);

        // Create a transparent button over the panel
        JButton button = new JButton();
        button.setOpaque(false);
        button.setContentAreaFilled(false);
        button.setBorderPainted(false);
        button.setFocusPainted(false);
        button.setPreferredSize(new Dimension(250, 120));

        button.addActionListener(e -> {
            if (role.equals("Customer")) {
                card.show(mainPanel, "CustomerLogin");
            } else {
                card.show(mainPanel, "ManagerLogin");
            }
        });

        panel.add(button, BorderLayout.CENTER);

        return panel;
    }

    // CUSTOMER LOGIN PANEL
    private JPanel createCustomerLoginPanel() {
        return createLoginPanel("Customer", CUSTOMER_COLOR, "CustomerRegister", "CustomerDashboard");
    }

    // MANAGER LOGIN PANEL  
    private JPanel createManagerLoginPanel() {
        return createLoginPanel("Fleet Manager", MANAGER_COLOR, "ManagerRegister", "ManagerDashboard");
    }

    private JPanel createLoginPanel(String userType, Color headerColor, String registerCard, String dashboardCard) {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(BACKGROUND_COLOR);

        // Header
        JPanel headerPanel = new JPanel(new BorderLayout());
        headerPanel.setBackground(headerColor);
        headerPanel.setPreferredSize(new Dimension(800, 100));

        JButton backBtn = new JButton("â† Back to Role Selection");
        backBtn.setBackground(Color.WHITE);
        backBtn.setForeground(headerColor);
        backBtn.setFocusPainted(false);
        backBtn.setBorder(BorderFactory.createEmptyBorder(5, 10, 5, 10));
        backBtn.addActionListener(e -> card.show(mainPanel, "UserType"));

        JPanel backPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        backPanel.setBackground(headerColor);
        backPanel.add(backBtn);
        headerPanel.add(backPanel, BorderLayout.WEST);

        JLabel title = new JLabel(userType + " Login", SwingConstants.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 24));
        title.setForeground(Color.WHITE);
        headerPanel.add(title, BorderLayout.CENTER);

        panel.add(headerPanel, BorderLayout.NORTH);

        // Center form
        JPanel formPanel = new JPanel(new GridBagLayout());
        formPanel.setBackground(BACKGROUND_COLOR);
        formPanel.setBorder(BorderFactory.createEmptyBorder(40, 100, 40, 100));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.insets = new Insets(10, 10, 10, 10);

        JLabel loginLabel = new JLabel("Login to Your " + userType + " Account", SwingConstants.CENTER);
        loginLabel.setFont(new Font("Segoe UI", Font.BOLD, 20));
        loginLabel.setForeground(TEXT_COLOR);
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 2;
        formPanel.add(loginLabel, gbc);

        gbc.gridwidth = 1;
        gbc.gridy = 1; gbc.gridx = 0;
        formPanel.add(createFormLabel("Username:"), gbc);
        gbc.gridx = 1;
        JTextField userField = createFormTextField();
        formPanel.add(userField, gbc);

        gbc.gridy = 2; gbc.gridx = 0;
        formPanel.add(createFormLabel("Password:"), gbc);
        gbc.gridx = 1;
        JPasswordField passField = createFormPasswordField();
        formPanel.add(passField, gbc);

        gbc.gridy = 3; gbc.gridx = 0; gbc.gridwidth = 2;
        JPanel buttonPanel = new JPanel(new FlowLayout());
        buttonPanel.setBackground(BACKGROUND_COLOR);
        JButton loginBtn = createStyledButton("Login", headerColor);
        JButton regBtn = createSecondaryButton("Create Account");
        buttonPanel.add(loginBtn);
        buttonPanel.add(regBtn);
        formPanel.add(buttonPanel, gbc);

        panel.add(formPanel, BorderLayout.CENTER);

        String finalUserType = userType.equals("Fleet Manager") ? USER_MANAGER : USER_CUSTOMER;
        
        loginBtn.addActionListener(e -> attemptLogin(userField.getText().trim(), 
            new String(passField.getPassword()).trim(), finalUserType, dashboardCard));

        regBtn.addActionListener(e -> card.show(mainPanel, registerCard));

        return panel;
    }

    // CUSTOMER REGISTER PANEL
    private JPanel createCustomerRegisterPanel() {
        return createRegisterPanel("Customer", CUSTOMER_COLOR, "CustomerLogin", USER_CUSTOMER);
    }

    // MANAGER REGISTER PANEL
    private JPanel createManagerRegisterPanel() {
        return createRegisterPanel("Fleet Manager", MANAGER_COLOR, "ManagerLogin", USER_MANAGER);
    }

    private JPanel createRegisterPanel(String userType, Color headerColor, String loginCard, String userTypeConstant) {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(BACKGROUND_COLOR);

        // Header
        JPanel headerPanel = new JPanel(new BorderLayout());
        headerPanel.setBackground(headerColor);
        headerPanel.setPreferredSize(new Dimension(800, 100));

        JButton backBtn = new JButton("â† Back to Login");
        backBtn.setBackground(Color.WHITE);
        backBtn.setForeground(headerColor);
        backBtn.setFocusPainted(false);
        backBtn.setBorder(BorderFactory.createEmptyBorder(5, 10, 5, 10));
        backBtn.addActionListener(e -> card.show(mainPanel, loginCard));

        JPanel backPanel = new JPanel(new FlowLayout(FlowLayout.LEFT));
        backPanel.setBackground(headerColor);
        backPanel.add(backBtn);
        headerPanel.add(backPanel, BorderLayout.WEST);

        JLabel title = new JLabel("Create " + userType + " Account", SwingConstants.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 24));
        title.setForeground(Color.WHITE);
        headerPanel.add(title, BorderLayout.CENTER);

        panel.add(headerPanel, BorderLayout.NORTH);

        // Center form
        JPanel formPanel = new JPanel(new GridBagLayout());
        formPanel.setBackground(BACKGROUND_COLOR);
        formPanel.setBorder(BorderFactory.createEmptyBorder(40, 100, 40, 100));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.insets = new Insets(10, 10, 10, 10);

        JLabel registerLabel = new JLabel("Create Your " + userType + " Account", SwingConstants.CENTER);
        registerLabel.setFont(new Font("Segoe UI", Font.BOLD, 20));
        registerLabel.setForeground(TEXT_COLOR);
        gbc.gridx = 0; gbc.gridy = 0; gbc.gridwidth = 2;
        formPanel.add(registerLabel, gbc);

        gbc.gridwidth = 1;
        gbc.gridy = 1; gbc.gridx = 0;
        formPanel.add(createFormLabel("Username:"), gbc);
        gbc.gridx = 1;
        JTextField userField = createFormTextField();
        formPanel.add(userField, gbc);

        gbc.gridy = 2; gbc.gridx = 0;
        formPanel.add(createFormLabel("Password:"), gbc);
        gbc.gridx = 1;
        JPasswordField passField = createFormPasswordField();
        formPanel.add(passField, gbc);

        gbc.gridy = 3; gbc.gridx = 0; gbc.gridwidth = 2;
        JPanel buttonPanel = new JPanel(new FlowLayout());
        buttonPanel.setBackground(BACKGROUND_COLOR);
        JButton createBtn = createStyledButton("Create Account", headerColor);
        JButton backToLoginBtn = createSecondaryButton("Back to Login");
        buttonPanel.add(createBtn);
        buttonPanel.add(backToLoginBtn);
        formPanel.add(buttonPanel, gbc);

        panel.add(formPanel, BorderLayout.CENTER);

        createBtn.addActionListener(e -> {
            String u = userField.getText().trim();
            String p = new String(passField.getPassword()).trim();
            if (u.isEmpty() || p.isEmpty()) {
                showError("Please fill all fields.");
                return;
            }
            for (User user : users) {
                if (user.username.equals(u)) {
                    showError("Username already exists!");
                    return;
                }
            }
            users.add(new User(u, p, userTypeConstant));
            saveData();
            showSuccess("Account created successfully!" + 
                (userTypeConstant.equals(USER_CUSTOMER) ? " Welcome bonus: 100 points" : ""));
            card.show(mainPanel, loginCard);
        });

        backToLoginBtn.addActionListener(e -> card.show(mainPanel, loginCard));

        return panel;
    }

    // CUSTOMER DASHBOARD
    private JPanel createCustomerDashboardPanel() {
        return createDashboardPanel("Customer Dashboard", CUSTOMER_COLOR, 
            new String[][]{
                {"Browse Vehicles", "View all available cars for rent", "View Cars"},
                {"Smart Recommendations", "Get AI-powered car suggestions", "Recommendations"},
                {"Rent Vehicle", "Rent a car for your trip", "Rent Car"},
                {"My Rentals", "View and return your rented cars", "My Rentals"}
            });
    }

    // MANAGER DASHBOARD
    private JPanel createManagerDashboardPanel() {
        return createDashboardPanel("Fleet Manager Dashboard", MANAGER_COLOR,
            new String[][]{
                {"Add Vehicle", "Add new cars to the rental fleet", "Add Car"},
                {"View Fleet", "Browse and manage all vehicles", "View Fleet"},
                {"Business Analytics", "View rental statistics and insights", "Analytics"},
                {"Maintenance", "Check vehicle maintenance status", "Maintenance"}
            });
    }

    private JPanel createDashboardPanel(String titleText, Color headerColor, String[][] features) {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(BACKGROUND_COLOR);

        // Header
        JPanel headerPanel = new JPanel(new BorderLayout());
        headerPanel.setBackground(headerColor);
        headerPanel.setPreferredSize(new Dimension(800, 100));

        JLabel titleLabel = new JLabel(titleText, SwingConstants.CENTER);
        titleLabel.setFont(new Font("Segoe UI", Font.BOLD, 28));
        titleLabel.setForeground(Color.WHITE);
        headerPanel.add(titleLabel, BorderLayout.CENTER);

        // User info panel
        JPanel userInfoPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        userInfoPanel.setBackground(headerColor);
        userInfoPanel.setBorder(BorderFactory.createEmptyBorder(5, 10, 5, 10));
        
        if (loggedUser != null) {
            String userInfoText = loggedUser.isManager() ? 
                "Manager: " + loggedUser.username :
                String.format("Welcome, %s | %s Member | Points: %d", 
                    loggedUser.username, loggedUser.badge, loggedUser.loyaltyPoints);
            
            JLabel userInfo = new JLabel(userInfoText);
            userInfo.setFont(new Font("Segoe UI", Font.PLAIN, 14));
            userInfo.setForeground(Color.WHITE);
            userInfoPanel.add(userInfo);
        }
        
        headerPanel.add(userInfoPanel, BorderLayout.SOUTH);
        panel.add(headerPanel, BorderLayout.NORTH);

        // Main content - Cards layout
        JPanel contentPanel = new JPanel(new GridLayout(2, 2, 20, 20));
        contentPanel.setBackground(BACKGROUND_COLOR);
        contentPanel.setBorder(BorderFactory.createEmptyBorder(30, 30, 30, 30));

        // Create feature cards
        for (String[] feature : features) {
            contentPanel.add(createFeatureCard(feature[0], feature[1], feature[2], headerColor));
        }

        panel.add(contentPanel, BorderLayout.CENTER);

        // Footer with logout
        JPanel footerPanel = new JPanel();
        footerPanel.setBackground(BACKGROUND_COLOR);
        footerPanel.setBorder(BorderFactory.createEmptyBorder(10, 0, 10, 0));
        JButton logoutBtn = createSecondaryButton("Logout");
        footerPanel.add(logoutBtn);
        panel.add(footerPanel, BorderLayout.SOUTH);

        logoutBtn.addActionListener(e -> logout());

        return panel;
    }

    private JPanel createFeatureCard(String title, String description, String action, Color color) {
        JPanel card = new JPanel(new BorderLayout());
        card.setBackground(CARD_COLOR);
        card.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(200, 200, 200), 1),
            BorderFactory.createEmptyBorder(20, 20, 20, 20)
        ));
        card.setCursor(new Cursor(Cursor.HAND_CURSOR));

        // Title
        JLabel titleLabel = new JLabel(title, SwingConstants.CENTER);
        titleLabel.setFont(new Font("Segoe UI", Font.BOLD, 16));
        titleLabel.setForeground(color);
        card.add(titleLabel, BorderLayout.NORTH);

        // Description
        JTextArea descArea = new JTextArea(description);
        descArea.setEditable(false);
        descArea.setLineWrap(true);
        descArea.setWrapStyleWord(true);
        descArea.setBackground(CARD_COLOR);
        descArea.setFont(new Font("Segoe UI", Font.PLAIN, 12));
        descArea.setForeground(TEXT_COLOR);
        descArea.setBorder(BorderFactory.createEmptyBorder(10, 0, 15, 0));
        card.add(descArea, BorderLayout.CENTER);

        // Action button
        JButton actionBtn = new JButton(action);
        actionBtn.setBackground(color);
        actionBtn.setForeground(Color.WHITE);
        actionBtn.setFont(new Font("Segoe UI", Font.BOLD, 12));
        actionBtn.setFocusPainted(false);
        card.add(actionBtn, BorderLayout.SOUTH);

        // Add action listener
        actionBtn.addActionListener(e -> handleDashboardAction(action));

        return card;
    }

    private void handleDashboardAction(String action) {
        switch (action) {
            case "View Cars":
            case "View Fleet":
                viewCars();
                break;
            case "Recommendations":
                showAIRecommendations();
                break;
            case "Rent Car":
                rentCarWithAI();
                break;
            case "My Rentals":
                returnAndRateCar();
                break;
            case "Add Car":
                addSmartCar();
                break;
            case "Analytics":
                card.show(mainPanel, "Analytics");
                break;
            case "Maintenance":
                showMaintenanceStatus();
                break;
        }
    }

    // CUSTOMER FEATURES
    private void showAIRecommendations() {
        if (cars.isEmpty()) {
            showInfo("No cars available for recommendations.");
            return;
        }

        java.util.List<SmartCar> recommendations = cars.stream()
            .filter(car -> car.available)
            .sorted((c1, c2) -> {
                double score1 = (c1.rating * 0.4) + (c1.fuelLevel * 0.3) + (1000/c1.calculateDynamicPrice() * 0.3);
                double score2 = (c2.rating * 0.4) + (c2.fuelLevel * 0.3) + (1000/c2.calculateDynamicPrice() * 0.3);
                return Double.compare(score2, score1);
            })
            .limit(3)
            .collect(Collectors.toList());

        StringBuilder sb = new StringBuilder("Smart Recommendations:\n\n");
        sb.append("Based on: Rating, Fuel Level, and Value\n\n");
        
        for (int i = 0; i < recommendations.size(); i++) {
            SmartCar car = recommendations.get(i);
            sb.append(i + 1).append(". ").append(car.toString()).append("\n");
            sb.append("   Location: ").append(car.location).append("\n");
            sb.append("   Recommendation Score: Excellent\n\n");
        }

        showScrollableMessage("Car Recommendations", sb.toString());
    }

    private void rentCarWithAI() {
        if (cars.isEmpty()) {
            showInfo("No cars available to rent.");
            return;
        }

        java.util.List<SmartCar> availableCars = cars.stream()
            .filter(car -> car.available)
            .collect(Collectors.toList());

        if (availableCars.isEmpty()) {
            showInfo("All cars are currently rented. Please check back later.");
            return;
        }

        StringBuilder sb = new StringBuilder("Available Cars:\n\n");
        for (int i = 0; i < availableCars.size(); i++) {
            SmartCar car = availableCars.get(i);
            sb.append(i + 1).append(". ").append(car.toString()).append("\n");
        }

        String carNum = JOptionPane.showInputDialog(this, sb.toString() + "\nEnter Car Number to rent:");

        SmartCar car = findCar(carNum);
        if (car != null && car.available) {
            String daysStr = JOptionPane.showInputDialog("Enter rental days:");
            try {
                int days = Integer.parseInt(daysStr);
                if (days <= 0) {
                    showError("Please enter a positive number of days.");
                    return;
                }
                
                double originalPrice = days * car.calculateDynamicPrice();
                double finalPrice = loggedUser.applyDiscount(originalPrice);
                int pointsEarned = (int)(finalPrice / 10);
                int oldPoints = loggedUser.loyaltyPoints;
                
                int confirm = JOptionPane.showConfirmDialog(this, 
                    "Rental Summary:\n" +
                    "Car: " + car.model + " (" + car.number + ")\n" +
                    "Days: " + days + "\n" +
                    "Daily Rate: $" + car.calculateDynamicPrice() + "\n" +
                    "Original Total: $" + originalPrice + "\n" +
                    "Your Discount: $" + (originalPrice - finalPrice) + "\n" +
                    "Final Price: $" + finalPrice + "\n" +
                    "Points to Earn: " + pointsEarned + "\n\n" +
                    "Confirm rental?",
                    "Confirm Rental", JOptionPane.YES_NO_OPTION);

                if (confirm == JOptionPane.YES_OPTION) {
                    car.available = false;
                    car.rentedTo = loggedUser.username;
                    car.rentalCount++;
                    
                    loggedUser.addRentalPoints(finalPrice);
                    
                    RentalRecord record = new RentalRecord(car.number, loggedUser.username, 
                        LocalDate.now(), finalPrice);
                    rentals.add(record);
                    
                    saveData();
                    
                    showSuccess(
                        "Car rented successfully!\n" +
                        "Final Charge: $" + finalPrice + "\n" +
                        "Points Earned: " + pointsEarned + "\n" +
                        "Total Points: " + loggedUser.loyaltyPoints + " (was " + oldPoints + ")\n" +
                        "Car is now unavailable for other users."
                    );
                }
            } catch (NumberFormatException ex) {
                showError("Please enter a valid number of days.");
            }
        } else {
            showError("Car not found or already rented!");
        }
    }

    private void returnAndRateCar() {
        java.util.List<SmartCar> userRentedCars = cars.stream()
            .filter(car -> !car.available && car.rentedTo != null && car.rentedTo.equals(loggedUser.username))
            .collect(Collectors.toList());

        if (userRentedCars.isEmpty()) {
            showInfo("You don't have any rented cars to return.");
            return;
        }

        StringBuilder sb = new StringBuilder("Your Rented Cars:\n\n");
        for (int i = 0; i < userRentedCars.size(); i++) {
            SmartCar car = userRentedCars.get(i);
            sb.append(i + 1).append(". ").append(car.model).append(" (").append(car.number).append(")\n");
        }

        String carNum = JOptionPane.showInputDialog(this, sb.toString() + "\nEnter Car Number to return:");

        SmartCar car = findCar(carNum);
        if (car != null && !car.available && car.rentedTo != null && car.rentedTo.equals(loggedUser.username)) {
            car.fuelLevel = Math.max(0, car.fuelLevel - new Random().nextInt(30));
            car.mileage += new Random().nextInt(100);
            
            String ratingStr = JOptionPane.showInputDialog("Rate this car (1-5 stars):");
            try {
                int rating = Integer.parseInt(ratingStr);
                if (rating < 1 || rating > 5) {
                    showError("Please enter rating between 1-5!");
                    return;
                }
                car.rating = (car.rating + rating) / 2;
                
                car.available = true;
                car.rentedTo = null;
                saveData();
                
                showSuccess(
                    "Car returned successfully!\n" +
                    "New Average Rating: " + String.format("%.1f", car.rating) + "/5\n" +
                    "Remaining Fuel: " + car.fuelLevel + "%\n" +
                    "Thank you for your feedback!"
                );
                    
            } catch (NumberFormatException ex) {
                showError("Please enter a valid rating number!");
            }
        } else {
            showError("Car not found or not rented by you!");
        }
    }

    // MANAGER FEATURES
    private void addSmartCar() {
        JPanel panel = new JPanel(new GridLayout(5, 2, 10, 10));
        panel.add(new JLabel("Model:"));
        JTextField modelField = new JTextField();
        panel.add(modelField);
        
        panel.add(new JLabel("Car Number:"));
        JTextField numberField = new JTextField();
        panel.add(numberField);
        
        panel.add(new JLabel("Base Rate:"));
        JTextField rateField = new JTextField();
        panel.add(rateField);
        
        panel.add(new JLabel("Location:"));
        JTextField locationField = new JTextField();
        panel.add(locationField);
        
        panel.add(new JLabel("Initial Fuel %:"));
        JTextField fuelField = new JTextField("100");
        panel.add(fuelField);

        int result = JOptionPane.showConfirmDialog(this, panel, "Add New Car to Fleet", 
            JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE);
        
        if (result == JOptionPane.OK_OPTION) {
            try {
                double rate = Double.parseDouble(rateField.getText());
                int fuel = Integer.parseInt(fuelField.getText());
                SmartCar car = new SmartCar(
                    modelField.getText(), 
                    numberField.getText(), 
                    rate, 
                    locationField.getText()
                );
                car.fuelLevel = Math.min(100, Math.max(0, fuel));
                cars.add(car);
                saveData();
                showSuccess("Car added successfully to the fleet!");
            } catch (NumberFormatException ex) {
                showError("Please enter valid numbers for rate and fuel level.");
            } catch (Exception ex) {
                showError("Invalid input provided.");
            }
        }
    }

    private void showMaintenanceStatus() {
        if (cars.isEmpty()) {
            showInfo("No cars in the fleet.");
            return;
        }
        
        StringBuilder sb = new StringBuilder("Fleet Maintenance Status:\n\n");
        for (int i = 0; i < cars.size(); i++) {
            SmartCar car = cars.get(i);
            String status = car.getMaintenanceStatus();
            String statusIcon = status.equals("Needs Service") ? "ðŸ”´ " : status.equals("Due Soon") ? "ðŸŸ¡ " : "ðŸŸ¢ ";
            sb.append(i + 1).append(". ").append(car.model).append(" (").append(car.number).append(")\n");
            sb.append("   Maintenance: ").append(statusIcon).append(status).append("\n");
            sb.append("   Last Service: ").append(car.lastMaintenance).append("\n");
            sb.append("   Mileage: ").append(car.mileage).append("km\n\n");
        }
        
        showScrollableMessage("Maintenance Status", sb.toString());
    }

    private void viewCars() {
        if (cars.isEmpty()) {
            showInfo("No cars available.");
            return;
        }
        
        StringBuilder sb = new StringBuilder("Vehicle Fleet:\n\n");
        for (int i = 0; i < cars.size(); i++) {
            SmartCar car = cars.get(i);
            sb.append(i + 1).append(". ").append(car.toString()).append("\n");
            if (loggedUser.isManager()) {
                sb.append("   Maintenance: ").append(car.getMaintenanceStatus()).append("\n");
                sb.append("   Fuel Level: ").append(car.fuelLevel).append("%\n");
            }
            sb.append("\n");
        }
        
        showScrollableMessage("Vehicle Fleet", sb.toString());
    }

    private JPanel createAnalyticsPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(BACKGROUND_COLOR);

        JLabel title = new JLabel("Business Analytics Dashboard", SwingConstants.CENTER);
        title.setFont(new Font("Segoe UI", Font.BOLD, 24));
        title.setForeground(PRIMARY_COLOR);
        title.setBorder(BorderFactory.createEmptyBorder(20, 0, 20, 0));
        panel.add(title, BorderLayout.NORTH);

        JTextArea analyticsArea = new JTextArea();
        analyticsArea.setEditable(false);
        analyticsArea.setFont(new Font("Consolas", Font.PLAIN, 12));
        analyticsArea.setBackground(CARD_COLOR);
        analyticsArea.setForeground(TEXT_COLOR);
        analyticsArea.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));

        // Generate analytics
        StringBuilder analytics = new StringBuilder();
        analytics.append("BUSINESS ANALYTICS\n");
        analytics.append("==================\n\n");
        
        double totalRevenue = rentals.stream().mapToDouble(r -> r.amount).sum();
        analytics.append("Total Revenue: $").append(String.format("%.2f", totalRevenue)).append("\n");
        
        long availableCars = cars.stream().filter(car -> car.available).count();
        long rentedCars = cars.stream().filter(car -> !car.available).count();
        analytics.append("Available Cars: ").append(availableCars).append("\n");
        analytics.append("Rented Cars: ").append(rentedCars).append("\n");
        
        if (!cars.isEmpty()) {
            SmartCar mostPopular = cars.stream()
                .max(Comparator.comparingInt(c -> c.rentalCount))
                .orElse(cars.get(0));
            analytics.append("Most Popular Car: ").append(mostPopular.model)
                     .append(" (").append(mostPopular.rentalCount).append(" rentals)\n");
        }
        
        if (!users.isEmpty()) {
            User topCustomer = users.stream()
                .filter(User::isCustomer)
                .max(Comparator.comparingDouble(u -> u.totalSpent))
                .orElse(null);
            if (topCustomer != null) {
                analytics.append("Top Customer: ").append(topCustomer.username)
                         .append(" ($").append(String.format("%.2f", topCustomer.totalSpent)).append(")\n");
            }
        }

        analyticsArea.setText(analytics.toString());
        
        JButton backBtn = createSecondaryButton("Back to Dashboard");
        backBtn.addActionListener(e -> {
            if (loggedUser.isCustomer()) {
                card.show(mainPanel, "CustomerDashboard");
            } else {
                card.show(mainPanel, "ManagerDashboard");
            }
        });

        JPanel bottomPanel = new JPanel();
        bottomPanel.setBackground(BACKGROUND_COLOR);
        bottomPanel.add(backBtn);

        panel.add(new JScrollPane(analyticsArea), BorderLayout.CENTER);
        panel.add(bottomPanel, BorderLayout.SOUTH);

        return panel;
    }

    // Helper methods for UI components
    private JLabel createFormLabel(String text) {
        JLabel label = new JLabel(text);
        label.setFont(new Font("Segoe UI", Font.BOLD, 14));
        label.setForeground(TEXT_COLOR);
        return label;
    }

    private JTextField createFormTextField() {
        JTextField field = new JTextField(20);
        field.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        field.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(200, 200, 200), 1),
            BorderFactory.createEmptyBorder(8, 8, 8, 8)
        ));
        return field;
    }

    private JPasswordField createFormPasswordField() {
        JPasswordField field = new JPasswordField(20);
        field.setFont(new Font("Segoe UI", Font.PLAIN, 14));
        field.setBorder(BorderFactory.createCompoundBorder(
            BorderFactory.createLineBorder(new Color(200, 200, 200), 1),
            BorderFactory.createEmptyBorder(8, 8, 8, 8)
        ));
        return field;
    }

    private JButton createStyledButton(String text, Color color) {
        JButton button = new JButton(text);
        button.setBackground(color);
        button.setForeground(Color.WHITE);
        button.setFont(new Font("Segoe UI", Font.BOLD, 14));
        button.setFocusPainted(false);
        button.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
        return button;
    }

    private JButton createSecondaryButton(String text) {
        JButton button = new JButton(text);
        button.setBackground(SECONDARY_COLOR);
        button.setForeground(Color.WHITE);
        button.setFont(new Font("Segoe UI", Font.BOLD, 14));
        button.setFocusPainted(false);
        button.setBorder(BorderFactory.createEmptyBorder(10, 20, 10, 20));
        return button;
    }

    private void showScrollableMessage(String title, String message) {
        JTextArea area = new JTextArea(message);
        area.setEditable(false);
        area.setFont(new Font("Consolas", Font.PLAIN, 12));
        area.setBackground(CARD_COLOR);
        area.setForeground(TEXT_COLOR);
        JScrollPane scroll = new JScrollPane(area);
        scroll.setPreferredSize(new Dimension(600, 400));
        JOptionPane.showMessageDialog(this, scroll, title, JOptionPane.INFORMATION_MESSAGE);
    }

    private void showSuccess(String message) {
        JOptionPane.showMessageDialog(this, message, "Success", JOptionPane.INFORMATION_MESSAGE);
    }

    private void showError(String message) {
        JOptionPane.showMessageDialog(this, message, "Error", JOptionPane.ERROR_MESSAGE);
    }

    private void showInfo(String message) {
        JOptionPane.showMessageDialog(this, message, "Information", JOptionPane.INFORMATION_MESSAGE);
    }

    private SmartCar findCar(String number) {
        if (number == null || number.trim().isEmpty()) return null;
        return cars.stream()
            .filter(car -> car.number.equalsIgnoreCase(number.trim()))
            .findFirst()
            .orElse(null);
    }

    private void attemptLogin(String username, String password, String userType, String dashboardCard) {
        for (User user : users) {
            if (user.username.equals(username) && user.password.equals(password) && user.userType.equals(userType)) {
                loggedUser = user;
                showSuccess("Welcome back, " + username + "!");
                card.show(mainPanel, dashboardCard);
                return;
            }
        }
        showError("Invalid credentials or user type mismatch!");
    }

    private void logout() {
        saveData();
        showInfo("Thank you for using Professional Car Rental System!");
        loggedUser = null;
        card.show(mainPanel, "UserType");
    }

    // Data persistence methods
    static void saveData() {
        try (ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(CARS_FILE))) {
            out.writeObject(cars);
        } catch (IOException e) {
            System.err.println("Error saving cars: " + e.getMessage());
        }
        
        try (ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(USERS_FILE))) {
            out.writeObject(users);
        } catch (IOException e) {
            System.err.println("Error saving users: " + e.getMessage());
        }
        
        try (ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream(RENTALS_FILE))) {
            out.writeObject(rentals);
        } catch (IOException e) {
            System.err.println("Error saving rentals: " + e.getMessage());
        }
    }

    @SuppressWarnings("unchecked")
    static void loadData() {
        try (ObjectInputStream in = new ObjectInputStream(new FileInputStream(CARS_FILE))) {
            cars = (ArrayList<SmartCar>) in.readObject();
        } catch (FileNotFoundException e) {
            cars = new ArrayList<>();
        } catch (IOException | ClassNotFoundException e) {
            System.err.println("Error loading cars: " + e.getMessage());
            cars = new ArrayList<>();
        }
        
        try (ObjectInputStream in = new ObjectInputStream(new FileInputStream(USERS_FILE))) {
            users = (ArrayList<User>) in.readObject();
        } catch (FileNotFoundException e) {
            users = new ArrayList<>();
        } catch (IOException | ClassNotFoundException e) {
            System.err.println("Error loading users: " + e.getMessage());
            users = new ArrayList<>();
        }
        
        try (ObjectInputStream in = new ObjectInputStream(new FileInputStream(RENTALS_FILE))) {
            rentals = (ArrayList<RentalRecord>) in.readObject();
        } catch (FileNotFoundException e) {
            rentals = new ArrayList<>();
        } catch (IOException | ClassNotFoundException e) {
            System.err.println("Error loading rentals: " + e.getMessage());
            rentals = new ArrayList<>();
        }
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(ProfessionalCarRentalApp::new);
    }
}
